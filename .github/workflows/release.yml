name: Release

permissions:
  contents: read

on:
  push:
    branches: [main]
    paths:
      - 'Cargo.toml'
      - 'src/**'
  workflow_dispatch:
    inputs:
      force:
        description: 'Force release with timestamp'
        type: boolean
        default: false

jobs:
  create-tag:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    outputs:
      tag: ${{ steps.create_tag.outputs.tag }}
      should_release: ${{ steps.check.outputs.should_release }}
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Extract version
        id: version
        run: |
          VERSION=$(grep '^version = ' Cargo.toml | head -1 | sed 's/version = "\(.*\)"/\1/')
          echo "version=$VERSION" >> "$GITHUB_OUTPUT"
          echo "ğŸ“¦ Detected version: $VERSION"

      - name: Check tag
        id: check
        run: |
          VERSION="${{ steps.version.outputs.version }}"
          TAG="v$VERSION"

          if git ls-remote --tags origin | grep -q "refs/tags/$TAG$"; then
            if [[ "${{ github.event.inputs.force }}" == "true" ]]; then
              TIMESTAMP=$(date +%Y%m%d-%H%M%S)
              TAG="v${VERSION}+${TIMESTAMP}"
              echo "should_release=true" >> "$GITHUB_OUTPUT"
            else
              echo "should_release=false" >> "$GITHUB_OUTPUT"
            fi
          else
            echo "should_release=true" >> "$GITHUB_OUTPUT"
          fi

          echo "tag=$TAG" >> "$GITHUB_OUTPUT"
          echo "ğŸ·ï¸ Tag: $TAG"

      - name: Create tag
        id: create_tag
        if: steps.check.outputs.should_release == 'true'
        run: |
          TAG="${{ steps.check.outputs.tag }}"
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git tag -a "$TAG" -m "Release $TAG"
          git push origin "$TAG"
          echo "tag=$TAG" >> "$GITHUB_OUTPUT"

  plan:
    needs: create-tag
    if: needs.create-tag.outputs.should_release == 'true'
    runs-on: ubuntu-latest
    outputs:
      has-artifacts: ${{ steps.plan.outputs.has-artifacts }}
      manifest: ${{ steps.plan.outputs.manifest }}
    env:
      GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      
    steps:
      - uses: actions/checkout@v4
        with:
          ref: ${{ needs.create-tag.outputs.tag }}

      - name: Install cargo-dist
        run: curl --proto '=https' --tlsv1.2 -LsSf https://github.com/axodotdev/cargo-dist/releases/download/v0.30.3/cargo-dist-installer.sh | sh

      - name: Cache dist
        uses: actions/upload-artifact@v4
        with:
          name: cargo-dist-cache
          path: ~/.cargo/bin/dist

      - name: Plan
        id: plan
        run: |
          dist host --steps=create --tag=${{ needs.create-tag.outputs.tag }} --output-format=json > plan.json
          cat plan.json
          echo "manifest=$(jq -c '.' plan.json)" >> "$GITHUB_OUTPUT"
          echo "has-artifacts=true" >> "$GITHUB_OUTPUT"

      - name: Upload plan
        uses: actions/upload-artifact@v4
        with:
          name: artifacts-plan
          path: plan.json

  build:
    needs: [create-tag, plan]
    if: needs.plan.outputs.has-artifacts == 'true'
    strategy:
      fail-fast: false
      matrix: ${{ fromJson(needs.plan.outputs.manifest).ci.github.artifacts_matrix }}
    runs-on: ${{ matrix.runner }}
    env:
      GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
    steps:
      - uses: actions/checkout@v4
        with:
          ref: ${{ needs.create-tag.outputs.tag }}

      - name: Install dist
        run: ${{ matrix.install_dist.run }}

      - name: Download plan
        uses: actions/download-artifact@v4
        with:
          pattern: artifacts-*
          path: target/distrib/
          merge-multiple: true

      - name: Build
        run: dist build --tag=${{ needs.create-tag.outputs.tag }} --output-format=json ${{ matrix.dist_args }} > build.json

      - name: Upload
        uses: actions/upload-artifact@v4
        with:
          name: artifacts-${{ join(matrix.targets, '_') }}
          path: |
            target/distrib/*
            build.json

  release:
    needs: [create-tag, plan, build]
    runs-on: ubuntu-latest
    permissions:
      contents: write
    env:
      GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
    steps:
      - uses: actions/checkout@v4
        with:
          ref: ${{ needs.create-tag.outputs.tag }}

      - name: Download dist
        uses: actions/download-artifact@v4
        with:
          name: cargo-dist-cache
          path: ~/.cargo/bin/

      - run: chmod +x ~/.cargo/bin/dist

      - name: Download artifacts
        uses: actions/download-artifact@v4
        with:
          pattern: artifacts-*
          path: target/distrib/
          merge-multiple: true

      - name: Publish
        run: |
          dist host --tag=${{ needs.create-tag.outputs.tag }} --steps=upload --steps=release --output-format=json > release.json
          cat release.json

      - name: Upload manifest
        uses: actions/upload-artifact@v4
        with:
          name: release-manifest
          path: release.json

  announce:
    needs: [create-tag, release]
    if: success()
    runs-on: ubuntu-latest
    steps:
      - run: echo "ğŸ‰ Release ${{ needs.create-tag.outputs.tag }} published!"
